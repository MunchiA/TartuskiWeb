{% extends 'base.html' %}

{% block title %}Calendario{% endblock %}

{% block styles %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
<link href="{{ url_for('static', filename='styles.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="flex flex-wrap gap-4 justify-between p-4">
  <!-- Calendario -->
  <div class="bg-white rounded-lg shadow-lg p-4 w-full md:w-4/5" style="max-width: 80%;">
    <div id="calendar" class="calendar-container"></div>
  </div>

  <!-- Lista de eventos -->
  <div class="sidebar bg-white rounded-lg shadow-lg p-4 w-full md:w-1/4">
    <h2 class="text-xl font-bold mb-4">Eventos</h2>
    <ul id="eventList" class="space-y-2">
      <!-- Llenado dinámico -->
    </ul>
  </div>
</div>

<!-- Modal -->
<div id="eventModal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded-lg shadow-lg max-w-md w-full">
    <h2 class="text-xl font-semibold mb-4" id="modalTitle">Crear Evento</h2>
    <form id="eventForm">
      <div class="mb-3">
        <label class="text-sm text-gray-600">Fecha</label>
        <input type="text" id="eventDate" name="fecha"
               class="w-full p-2 border rounded-md bg-gray-100" readonly>
      </div>
      <div class="mb-3">
        <label class="text-sm text-gray-600">Hora de inicio</label>
        <input type="time" id="eventStartTime" name="hora_inicio"
               class="w-full p-2 border rounded-md">
      </div>
      <div class="mb-3">
        <label class="text-sm text-gray-600">Hora de fin</label>
        <input type="time" id="eventEndTime" name="hora_fin"
               class="w-full p-2 border rounded-md">
      </div>
      <div class="mb-3">
        <label class="text-sm text-gray-600">Título</label>
        <input type="text" id="eventTitle" name="titulo"
               class="w-full p-2 border rounded-md">
      </div>
      <div class="mb-4">
        <label class="text-sm text-gray-600">Descripción</label>
        <textarea id="eventDescription" name="descripcion" rows="3"
                  class="w-full p-2 border rounded-md"></textarea>
      </div>
      <div class="flex justify-end gap-2">
        <button type="button" id="cancelButton"
                class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
          Cancelar
        </button>
        <button type="submit"
                class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
          Guardar
        </button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/es.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const calendarEl = document.getElementById('calendar');
    const eventModal = document.getElementById('eventModal');
    const eventForm = document.getElementById('eventForm');
    const cancelButton = document.getElementById('cancelButton');
    const eventDateInput = document.getElementById('eventDate');
    const eventTitle = document.getElementById('eventTitle');
    const eventDesc = document.getElementById('eventDescription');
    const eventStart = document.getElementById('eventStartTime');
    const eventEnd = document.getElementById('eventEndTime');
    const eventList = document.getElementById('eventList');
    let selectedDate = '';
  
    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      locale: 'es',
      height: 'auto',
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay'
      },
      dateClick(info) {
        selectedDate = info.dateStr;
        eventForm.reset(); // Primero resetea todo el formulario
        eventDateInput.value = selectedDate;  // Ahora sí pon la fecha en el input
        eventModal.classList.remove('hidden');
      },
      events: '/obtener-eventos', // Obtiene eventos desde el servidor
      eventsSet(events) {
        // Cada vez que FullCalendar carga o recarga eventos,
        // rellenamos la lista lateral
        eventList.innerHTML = ''; // Limpiar la lista de eventos antes de agregar nuevos
  
        events.forEach(ev => {
          const li = document.createElement('li');
          li.className = 'text-sm border-b pb-2';
  
          const eventTitleElement = document.createElement('strong');
          eventTitleElement.textContent = ev.title;
  
          const eventCreator = document.createElement('span');
          eventCreator.className = 'text-gray-500 text-xs';
          eventCreator.textContent = ev.creator || 'Desconocido';
  
          li.appendChild(eventTitleElement);
          li.appendChild(document.createElement('br'));
          li.appendChild(eventCreator);
  
          eventList.appendChild(li);
        });
      }
    });
  
    calendar.render();
  
    cancelButton.addEventListener('click', () => {
      eventModal.classList.add('hidden');
    });
  
    eventForm.addEventListener('submit', function (e) {
      e.preventDefault();
      fetch('/crear-evento', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          titulo: eventTitle.value,
          descripcion: eventDesc.value,
          fecha: eventDateInput.value,
          hora_inicio: eventStart.value,
          hora_fin: eventEnd.value
        })
      })
        .then(res => res.json())
        .then(data => {
          if (data.status === 'success') {
            // Agregar el evento dinámicamente en el calendario
            const newEvent = {
              id: data.id,
              title: eventTitle.value,
              start: eventDateInput.value + 'T' + eventStart.value,
              end: eventDateInput.value + 'T' + eventEnd.value,
              description: eventDesc.value,
              creator: 'Desconocido' // Este es un ejemplo, puedes agregar el creador si lo deseas
            };
            calendar.addEvent(newEvent); // Agregar el evento a FullCalendar
            eventModal.classList.add('hidden');
          } else {
            alert(data.message || 'Error al crear el evento');
          }
        })
        .catch(() => {
          alert('Error al conectar con el servidor');
        });
    });
  });
</script>
{% endblock %}
